generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization & Church Hierarchy
enum OrganizationStatus {
  ACTIVE
  INACTIVE
}

model Organization {
  id          String             @id @default(uuid())
  name        String             @unique
  description String?
  logoUrl     String?
  status      OrganizationStatus @default(ACTIVE)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  churches    Church[]
}

// User & Auth
enum Role {
  USER
  CHURCH_ADMIN
  TEACHER
  MODERATOR
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum Language {
  EN
  RW
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  password       String
  displayName    String?
  phoneNumber    String?
  district       String?
  language       Language       @default(EN)
  role           Role           @default(USER)
  status         UserStatus     @default(ACTIVE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relations
  church         Church?        @relation("ChurchAdmins", fields: [churchId], references: [id])
  churchId       String?
  
  posts          Post[]
  comments       Comment[]
  reactions      Reaction[]
  bookmarks      Bookmark[]
  enrollments    Enrollment[]
  certificates   Certificate[]
  reportsFiled   Report[]
  createdCourses Course[]       @relation("CreatedCourses")
  
  // Follows
  followedChurches FollowChurch[]
}

// Church & Directory
enum PublishStatus {
  DRAFT
  PUBLISHED
  HIDDEN
  DELETED
}

enum VerificationStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  REJECTED
}

model Church {
  id                String             @id @default(uuid())
  name              String
  district          String
  sector            String?
  address           String?
  description       String?
  contactPhone      String?
  contactEmail      String?
  website           String?
  serviceTimes      Json?              // Changed to Json for structured data
  logoUrl           String?
  verificationStatus VerificationStatus @default(DRAFT)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  organizationId    String
  organization      Organization       @relation(fields: [organizationId], references: [id])

  admins            User[]             @relation("ChurchAdmins")
  sermons           Sermon[]
  events            Event[]
  announcements     Announcement[]
  followers         FollowChurch[]
}

model FollowChurch {
  userId    String
  churchId  String
  user      User     @relation(fields: [userId], references: [id])
  church    Church   @relation(fields: [churchId], references: [id])
  createdAt DateTime @default(now())

  @@id([userId, churchId])
}

// Content: Sermons
enum MediaType {
  VIDEO
  AUDIO
  TEXT
}

model Sermon {
  id           String        @id @default(uuid())
  title        String
  description  String?
  preacherName String?
  mediaType    MediaType
  mediaUrl     String
  thumbnailUrl String?
  tags         String[]
  language     Language      @default(EN)
  status       PublishStatus @default(DRAFT)
  viewCount    Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  churchId     String
  church       Church        @relation(fields: [churchId], references: [id])
  
  comments     Comment[]
  reactions    Reaction[]
  bookmarks    Bookmark[]
}

// Content: Events & Announcements
model Event {
  id               String        @id @default(uuid())
  title            String
  description      String?
  startDateTime    DateTime
  endDateTime      DateTime
  location         String?
  district         String?
  organizerContact String?
  bannerImageUrl   String?
  status           PublishStatus @default(DRAFT)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  churchId         String
  church           Church        @relation(fields: [churchId], references: [id])
}

model Announcement {
  id           String        @id @default(uuid())
  title        String
  body         String
  startVisible DateTime
  endVisible   DateTime
  status       PublishStatus @default(DRAFT)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  churchId     String
  church       Church        @relation(fields: [churchId], references: [id])
}

// Content: Devotions
model Devotion {
  id                  String        @id @default(uuid())
  date                DateTime      @unique // One per day ideally
  title               String
  bibleReference      String
  verseText           String
  content             String
  prayer              String?
  reflectionQuestions String[]
  language            Language      @default(EN)
  featured            Boolean       @default(false)
  status              PublishStatus @default(DRAFT)
  authorId            String?       // Could be tied to a User or just text
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  comments            Comment[]
  reactions           Reaction[]
  bookmarks           Bookmark[]
}

model Bookmark {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
  
  // Polymorphic-ish relations (could use separate tables for stricter types)
  sermonId   String?
  sermon     Sermon?   @relation(fields: [sermonId], references: [id])
  devotionId String?
  devotion   Devotion? @relation(fields: [devotionId], references: [id])
  
  @@unique([userId, sermonId, devotionId]) 
}

// Bible Academy
enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model Course {
  id               String         @id @default(uuid())
  title            String
  description      String?
  category         String?
  level            CourseLevel    @default(BEGINNER)
  language         Language       @default(EN)
  coverImageUrl    String?
  estimatedDuration Int?          // in minutes
  status           PublishStatus  @default(DRAFT)
  approvalStatus   ApprovalStatus @default(PENDING)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  teacherId        String
  teacher          User           @relation("CreatedCourses", fields: [teacherId], references: [id])
  
  lessons          Lesson[]
  enrollments      Enrollment[]
}

model Lesson {
  id           String   @id @default(uuid())
  title        String
  content      String?
  tldr         String?
  videoUrl     String?
  orderIndex   Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  courseId     String
  course       Course   @relation(fields: [courseId], references: [id])
  
  quizzes      Quiz[]
  progress     LessonProgress[]
}

model Quiz {
  id          String         @id @default(uuid())
  question    String
  options     String[]
  correctAnswerIndex Int
  explanation String?
  
  lessonId    String
  lesson      Lesson         @relation(fields: [lessonId], references: [id])
}

model Enrollment {
  id             String    @id @default(uuid())
  userId         String
  courseId       String
  enrolledAt     DateTime  @default(now())
  completedAt    DateTime?
  progressPercent Float    @default(0)
  
  user           User      @relation(fields: [userId], references: [id])
  course         Course    @relation(fields: [courseId], references: [id])
  
  @@unique([userId, courseId])
}

model LessonProgress {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String
  completedAt DateTime?
  
  lesson      Lesson    @relation(fields: [lessonId], references: [id])
  // User relation could be added if needed directly, but usually queries go through Enrollment or direct join
  
  @@unique([userId, lessonId])
}

model Certificate {
  id           String   @id @default(uuid())
  issuedAt     DateTime @default(now())
  certificateCode String @unique @default(uuid()) // Unique code for verification
  certificateUrl String? // Link to generated PDF or verification page
  
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  courseId     String
  // Relation to Course might be useful too
  
  @@unique([userId, courseId]) // One cert per course per user
}

// Community
enum PostCategory {
  TESTIMONY
  QUESTION
  ENCOURAGEMENT
  PRAYER_REQUEST
}

model Post {
  id        String        @id @default(uuid())
  title     String
  body      String
  category  PostCategory
  tags      String[]
  language  Language      @default(EN)
  status    PublishStatus @default(PUBLISHED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  
  comments  Comment[]
  reactions Reaction[]
}

model Comment {
  id         String   @id @default(uuid())
  body       String
  status     PublishStatus @default(PUBLISHED)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  
  // Polymorphic relations
  postId     String?
  post       Post?    @relation(fields: [postId], references: [id])
  sermonId   String?
  sermon     Sermon?  @relation(fields: [sermonId], references: [id])
  devotionId String?
  devotion   Devotion? @relation(fields: [devotionId], references: [id])
}

enum ReactionType {
  LIKE
  AMEN
  HEART
}

model Reaction {
  id         String       @id @default(uuid())
  type       ReactionType
  userId     String
  user       User         @relation(fields: [userId], references: [id])
  
  postId     String?
  post       Post?        @relation(fields: [postId], references: [id])
  sermonId   String?
  sermon     Sermon?      @relation(fields: [sermonId], references: [id])
  devotionId String?
  devotion   Devotion?    @relation(fields: [devotionId], references: [id])

  @@unique([userId, postId, sermonId, devotionId])
}

// Trust & Safety
enum ReportReason {
  SPAM
  HATE_SPEECH
  HARASSMENT
  SCAM
  INAPPROPRIATE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

model Report {
  id          String       @id @default(uuid())
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  reporterId  String
  reporter    User         @relation(fields: [reporterId], references: [id])
  
  // Target ID (could be polymorphic or just store ID and type)
  targetId    String
  targetType  String       // "POST", "COMMENT", "SERMON", "USER", etc.
}

model ModerationAction {
  id          String   @id @default(uuid())
  action      String   // "HIDE", "DELETE", "WARN_USER", "SUSPEND_USER"
  reason      String?
  createdAt   DateTime @default(now())
  
  moderatorId String   // User ID of mod
  targetId    String
  targetType  String
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   // Recipient
  title     String
  body      String
  read      Boolean  @default(false)
  type      String   // "DEVOTION", "FOLLOW", "CERTIFICATE", "SYSTEM"
  data      Json?    // Extra payload
  createdAt DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  performedBy String?  // User ID or System
  targetType  String?
  targetId    String?
  details     Json?
  createdAt   DateTime @default(now())
}
